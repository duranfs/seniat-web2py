{{extend 'layout.html'}}

<div class="container-fluid">
  <h2 class="mt-4 mb-4"><i class="fas fa-tasks"></i> Monitor de Hilos Avanzado</h2>
  
  <!-- Panel de control -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between">
      <span><i class="fas fa-sliders-h"></i> Controles</span>
      <div>
        <button class="btn btn-sm btn-light mr-2" onclick="window.location.reload()">
          <i class="fas fa-sync-alt"></i> Actualizar
        </button>
        <a href="{{=URL('default', 'index')}}" class="btn btn-sm btn-light">
          <i class="fas fa-arrow-left"></i> Volver
        </a>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <div class="card bg-light mb-3">
            <div class="card-body text-center">
              <h5 class="card-title">Hilos Totales</h5>
              <p class="card-text display-4">{{=total_threads}}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light mb-3">
            <div class="card-body text-center">
              <h5 class="card-title">Hilos Activos</h5>
              <p class="card-text display-4 text-success">{{=active_threads}}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light mb-3">
            <div class="card-body text-center">
              <h5 class="card-title">Hilos Ocupados</h5>
              <p class="card-text display-4 text-warning">{{=busy_threads}}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light mb-3">
            <div class="card-body text-center">
              <h5 class="card-title">Uso CPU</h5>
              <p class="card-text display-4">{{=cpu_percent}}%</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla avanzada de hilos -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white">
      <i class="fas fa-table"></i> Diagnóstico Detallado de Hilos
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0" id="threadsTable">
          <thead class="thead-dark">
            <tr>
              <th>#</th>
              <th>Nombre</th>
              <th>ID</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Tiempo Vida</th>
              <th>Uso CPU</th>
              <th>Memoria</th>
              <th>Stack</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {{for i, thread in enumerate(threads_info):}}
            <tr>
              <td>{{=i+1}}</td>
              <td>{{=thread['name']}}</td>
              <td>{{=thread['ident']}}</td>
              <td>
                {{if thread['type'] == 'MainThread':}}
                  <span class="badge badge-primary">Principal</span>
                {{elif 'Rocket' in thread['name']:}}
                  <span class="badge badge-info">Rocket</span>
                {{else:}}
                  <span class="badge badge-secondary">Worker</span>
                {{pass}}
              </td>
              <td>
                <span class="badge badge-{{='success' if thread['alive'] else 'danger'}}">
                  {{='Activo' if thread['alive'] else 'Inactivo'}}
                </span>
              </td>
              <td>{{=thread['lifetime']}} seg</td>
              <td>
                <div class="progress" style="height: 20px;">
                  <div class="progress-bar bg-{{='warning' if thread['cpu'] > 50 else 'success'}}" 
                       role="progressbar" style="width: {{=thread['cpu']}}%" 
                       aria-valuenow="{{=thread['cpu']}}" aria-valuemin="0" aria-valuemax="100">
                    {{=thread['cpu']}}%
                  </div>
                </div>
              </td>
              <td>{{=thread['memory']}} MB</td>
              <td>
                <button class="btn btn-sm btn-outline-info" 
                        onclick="$('#stack-{{=i}}').toggle()">
                  <i class="fas fa-code"></i> Ver
                </button>
                <div id="stack-{{=i}}" style="display:none; font-size:0.8em; margin-top:5px;">
                  <pre>{{=thread['stack']}}</pre>
                </div>
              </td>
              <td>
                {{if thread['name'] != 'MainThread' and thread['alive']:}}
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="killThread({{=thread['ident']}})">
                  <i class="fas fa-skull"></i> Terminar
                </button>
                {{pass}}
              </td>
            </tr>
            {{pass}}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Gráficos de rendimiento -->
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-success text-white">
          <i class="fas fa-chart-line"></i> Uso de CPU por Hilo
        </div>
        <div class="card-body">
          <canvas id="cpuChart" height="200"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-warning text-white">
          <i class="fas fa-memory"></i> Uso de Memoria
        </div>
        <div class="card-body">
          <canvas id="memoryChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts avanzados -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Configuración de DataTables
$(document).ready(function() {
    $('#threadsTable').DataTable({
        dom: '<"top"Bf>rt<"bottom"lip><"clear">',
        buttons: ['copy', 'excel', 'pdf'],
        order: [[3, 'asc'], [5, 'desc']],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.10.20/i18n/Spanish.json'
        }
    });

    // Gráfico de CPU
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    new Chart(cpuCtx, {
        type: 'bar',
        data: {
            labels: [{{=','.join([f'"{t["name"]}"' for t in threads_info])}}],
            datasets: [{
                label: 'Uso de CPU %',
                data: [{{=','.join([str(t['cpu']) for t in threads_info])}}],
                backgroundColor: '#28a745'
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, max: 100 } }
        }
    });

    // Gráfico de Memoria
    const memCtx = document.getElementById('memoryChart').getContext('2d');
    new Chart(memCtx, {
        type: 'bar',
        data: {
            labels: [{{=','.join([f'"{t["name"]}"' for t in threads_info])}}],
            datasets: [{
                label: 'Uso de Memoria (MB)',
                data: [{{=','.join([str(t['memory']) for t in threads_info])}}],
                backgroundColor: '#ffc107'
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });
});

function killThread(threadId) {
    if (confirm('¿Está seguro de terminar este hilo? Esto puede afectar conexiones activas.')) {
        $.post('{{=URL("default", "kill_thread")}}', {thread_id: threadId}, function(data) {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}
</script>

<style>
.progress {
  min-width: 100px;
}
.badge {
  font-size: 0.85em;
  font-weight: 500;
}
pre {
  background: #f8f9fa;
  padding: 5px;
  border-radius: 3px;
  max-height: 150px;
  overflow-y: auto;
}
</style>