{{extend 'layout.html'}}
{{import json}}
<div class="container">
    <h2 class="mb-4">Horas por Actividades - {{=mes_actual}}</h2>
    
    <!-- Gráfico y Resumen -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <canvas id="actividadesChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Resumen por Proyecto</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height:300px;overflow-y:auto;">
                        <table class="table table-sm table-striped mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th>Proyecto</th>
                                    <th class="text-right">Horas</th>
                                </tr>
                            </thead>
                            <tbody>
                            {{for proyecto in proyectos:}}
                                <tr>
                                    <td>{{=proyecto}}</td>
                                    <td class="text-right">{{=format(totales_proyectos[proyecto], '.2f')}}</td>
                                </tr>
                            {{pass}}
                            </tbody>
                            <tfoot class="font-weight-bold bg-light">
                                <tr>
                                    <td>Total General</td>
                                    <td class="text-right">{{=format(total_general, '.2f')}}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabla detallada -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Detalle de Actividades</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead class="thead-light">
                        <tr>
                            <th>Fecha</th>
                            <th>Proyecto</th>
                            <th class="text-right">Horas</th>
                            <th class="text-right">Actividades</th>
                        </tr>
                    </thead>
                    <tbody>
                    {{for r in registros:}}
                        <tr>
                            <td>{{=r['fecha'].strftime('%d/%m/%Y') if 'fecha' in r else ''}}</td>
                            <td>{{=r['proyecto']}}</td>
                            <td class="text-right">{{=format(r['total_horas'], '.2f')}}</td>
                            <td class="text-right">{{=r['cantidad_actividades']}}</td>
                        </tr>
                    {{pass}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    var ctx = document.getElementById('actividadesChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{=XML(json.dumps([f.strftime('%d/%m') for f in fechas]))}},
            datasets: {{=XML(json.dumps(datasets))}}
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Horas Trabajadas'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(2);
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Días del Mes'
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.raw.toFixed(2) + ' horas';
                        }
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12
                    }
                }
            },
            maintainAspectRatio: false
        }
    });
});
</script>