<!DOCTYPE html>
<html>
<head>
    <script src="{{=URL('static','js/jquery-3.6.0.min.js')}}"></script>
    <style>
        .ambiente-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 40px;
            padding: 20px;
            margin-bottom: 40px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            background: #fafafa;
        }

        .db-node {
            position: relative;
            width: 250px;
            height: 250px;
            margin: auto;
            background: linear-gradient(135deg, #f9f9f9, #e8e8e8);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .db-node:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

        .node-center {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            position: absolute;
            top: 55px;
            left: 55px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
        }

        .node-name {
            font-size: 16px;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .node-server {
            font-size: 12px;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .parameter-ray {
            position: absolute;
            width: 110px;
            height: 3px;
            top: 125px;
            left: 125px;
            transform-origin: 0 0;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.1));
            transition: all 0.3s ease;
        }

        .parameter-ray:hover {
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.3));
            transform: scale(1.1);
        }

        .parameter-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            position: absolute;
            right: -9px;
            top: -8px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .parameter-dot:hover {
            transform: scale(1.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .parameter-name {
            font-size: 11px;
            position: absolute;
            right: 25px;
            top: -15px;
            background: transparent;
            padding: 3px 6px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            white-space: nowrap;
            font-weight: 500;
            color: #333;
            opacity: 1; /* Cambiado de 0 a 1 para que siempre sea visible */
            transition: opacity 0.3s ease;
            pointer-events: none;
            max-width: 120px; /* Limitar el ancho para evitar desbordamiento */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Ajustar posición para diferentes ángulos */
        .parameter-ray:nth-child(4n+1) .parameter-name {
            right: 25px;
            top: -15px;
        }
        
        .parameter-ray:nth-child(4n+2) .parameter-name {
            right: 25px;
            top: -15px;
        }
        
        .parameter-ray:nth-child(4n+3) .parameter-name {
            right: 25px;
            top: -15px;
        }
        
        .parameter-ray:nth-child(4n+4) .parameter-name {
            right: 25px;
            top: -15px;
        }

        /* Ajustar posición para parámetros en diferentes cuadrantes */
        .parameter-ray[style*="rotate(0deg)"] .parameter-name,
        .parameter-ray[style*="rotate(90deg)"] .parameter-name,
        .parameter-ray[style*="rotate(180deg)"] .parameter-name,
        .parameter-ray[style*="rotate(270deg)"] .parameter-name {
            right: 25px;
            top: -15px;
        }

        /* Para parámetros en el lado izquierdo, ajustar posición */
        .parameter-ray[style*="rotate(135deg)"] .parameter-name,
        .parameter-ray[style*="rotate(225deg)"] .parameter-name,
        .parameter-ray[style*="rotate(315deg)"] .parameter-name {
            right: 25px;
            top: -15px;
        }

        /* Para parámetros en el lado derecho, ajustar posición */
        .parameter-ray[style*="rotate(45deg)"] .parameter-name,
        .parameter-ray[style*="rotate(315deg)"] .parameter-name {
            right: 25px;
            top: -15px;
        }

        .param-ok { 
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border-color: #27ae60;
        }
        
        .param-error { 
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #c0392b;
        }
        
        .param-alert { 
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border-color: #e67e22;
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            max-width: 200px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #3498db;
        }

        .tooltip-content {
            line-height: 1.4;
        }

        .ambiente-title {
            text-align: center;
            color: #2c3e50;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .debug { 
            color: red; 
            font-weight: bold; 
        }

        /* Colores por ambiente */
        .produccion .node-center {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .calidad .node-center {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .desarrollo .node-center {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        .dataguard .node-center {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .otros .node-center {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
    </style>
</head>
<body>

<div id="content-container">
    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
        Monitor de Base de Datos 
    </h2>

    {{if mon is not None:}}
        <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">
            Total de registros monitoreados: <strong>{{=len(mon)}}</strong>
        </p>

        {{ from collections import defaultdict }}
        {{ agrupado = defaultdict(lambda: defaultdict(lambda: defaultdict(list))) }}
        {{ for m in mon: }}
            {{ if m.tx_resultado and m.tx_resultado.strip(): }}
                {{ ambiente = m.tx_ambiente.lower() if m.tx_ambiente else 'otros' }}
                {{ servidor = m.tx_servidor.upper() }}
                {{ instancia = m.tx_instancia.upper() }}
                {{ agrupado[ambiente][servidor][instancia].append(m) }}
            {{ pass }}
        {{ pass }}

        {{ orden_ambientes = ['produccion','calidad','desarrollo'] }}

        {{ for ambiente in orden_ambientes: }}
            {{ if ambiente in agrupado: }}
            <h3 class="ambiente-title">{{=ambiente.upper()}}</h3>
            <div class="ambiente-container">
              

                {{ for servidor, instancias in agrupado[ambiente].items(): }}
                    {{ for instancia, rutinas in instancias.items(): }}
                        <div class="db-node {{=ambiente}}" 
                             data-servidor="{{=servidor}}" 
                             data-instancia="{{=instancia}}"
                             data-ambiente="{{=ambiente}}">
                            
                            <div class="node-center">
                                <div class="node-name">{{=instancia}}</div>
                                <div class="node-server">{{=servidor}}</div>
                            </div>
                            
                            {{ total = len(rutinas) }}
                            {{ for i, r in enumerate(rutinas): }}
                                {{ estado = r.tx_resultado.upper() if r.tx_resultado else 'ALERTA' }}
                                {{ angulo = (360/total)*i }}
                                <div class="parameter-ray" 
                                     style="transform: rotate({{=angulo}}deg);"
                                     data-rutina="{{=r.tx_rutina}}"
                                     data-estado="{{=estado}}"
                                     data-resultado="{{=r.tx_resultado or 'Sin resultado'}}"
                                     data-ultima-ejecucion="{{=r.f_corrida.strftime('%Y-%m-%d %H:%M:%S') if r.f_corrida else 'N/A'}}"
                                     data-puerto="{{=r.tx_puerto or 'N/A'}}"
                                     data-tipo="{{=r.tx_tipobd or 'N/A'}}">
                                    
                                    <div class="parameter-dot 
                                        {{='param-ok' if estado=='OK' else ('param-error' if estado=='FALLO' else 'param-alert')}}">
                                    </div>
                                    <div class="parameter-name" title="{{=r.tx_rutina}}">{{=r.tx_rutina}}</div>
                                </div>
                            {{ pass }}
                        </div>
                    {{ pass }}
                {{ pass }}
            </div>
            {{else:}}
                <p class="debug">Ambiente {{=ambiente}} no tiene instancias.</p>
            {{ pass }}
        {{ pass }}
    {{else:}}
        <div class="debug" style="text-align: center; font-size: 18px;">
            ⚠ No hay datos de monitoreo disponibles
        </div>
    {{pass}}

    <!-- Tooltip flotante -->
    <div id="tooltip" class="tooltip"></div>
</div>

<script>
$(document).ready(function() {
    // Función para mostrar tooltip con información detallada
    function showTooltip(element, event) {
        const tooltip = $('#tooltip');
        const data = element.data();
        
        let content = `
            <div class="tooltip-title">${data.rutina}</div>
            <div class="tooltip-content">
                <strong>Estado:</strong> ${data.estado}<br>
                <strong>Resultado:</strong> ${data.resultado}<br>
                <strong>Última ejecución:</strong> ${data.ultimaEjecucion}<br>
                <strong>Puerto:</strong> ${data.puerto}<br>
                <strong>Tipo BD:</strong> ${data.tipo}
            </div>
        `;
        
        tooltip.html(content);
        tooltip.addClass('show');
        
        // Posicionar tooltip
        const rect = event.target.getBoundingClientRect();
        tooltip.css({
            left: rect.right + 10 + 'px',
            top: rect.top - 10 + 'px'
        });
    }
    
    // Función para ocultar tooltip
    function hideTooltip() {
        $('#tooltip').removeClass('show');
    }
    
    // Eventos para mostrar/ocultar tooltip
    $('.parameter-dot').on('mouseenter', function(e) {
        showTooltip($(this).closest('.parameter-ray'), e);
    });
    
    $('.parameter-dot').on('mouseleave', function() {
        hideTooltip();
    });
    
    // Eventos para el nodo completo
    $('.db-node').on('mouseenter', function() {
        $(this).addClass('hover');
    });
    
    $('.db-node').on('mouseleave', function() {
        $(this).removeClass('hover');
        hideTooltip();
    });
    
    // Actualización automática cada 5 minutos (en lugar de 30 segundos)
    setInterval(function() {
        location.reload();
    }, 300000); // 300000ms = 5 minutos
});
</script>

</body>
</html>
