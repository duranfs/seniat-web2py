{{extend 'layout.html'}}

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor BD Compacto</title>
    <script src="{{=URL('static','js/jquery-3.6.0.min.js')}}"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: #f5f5f5;
            padding: 10px;
            margin: 0;
            font-size: 10px;
        }
        
        .ambiente-container {
            margin-bottom: 15px;
        }
        
        .ambiente-title {
            color: #333;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 0 5px 0;
            padding-bottom: 3px;
            border-bottom: 1px solid #ddd;
        }
        
        .instancias-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }
        
        .instancia-card {
            background: white;
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 3px solid;
        }
        
        /* Colores por ambiente */
        .produccion { border-left-color: #3498db; background-color: #eaf2f8; }
        .calidad { border-left-color: #f39c12; background-color: #fef5e7; }
        .desarrollo { border-left-color: #2ecc71; background-color: #eafaf1; }
        .dataguard { border-left-color: #9b59b6; background-color: #f5eef8; }
        .otros { border-left-color: #95a5a6; background-color: #f2f4f4; }
        
        .instancia-card.alerta {
            animation: pulse-alert 2s infinite;
        }
        
        @keyframes pulse-alert {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.3); }
            70% { box-shadow: 0 0 0 5px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        .instancia-header {
            margin-bottom: 5px;
            line-height: 1.3;
        }
        
        .instancia-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .instancia-server {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .parametros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 5px;
        }
        
        .parametro {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .param-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .icon-ok {
            background: #2ecc71;
        }
        
        .icon-error {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .param-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(245,245,245,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #content-container {
            display: none;
        }
        
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .exit-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .filter-select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ddd;
            font-size: 12px;
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
</div>

<div id="content-container">

{{if mon:}}

{{ from collections import defaultdict }}
{{ agrupado = defaultdict(lambda: defaultdict(lambda: defaultdict(list))) }}
{{ for m in mon: }}
 {{  if m.tx_resultado_detalle is not None and '500 INTERNAL SERVER ERROR' in m.tx_resultado_detalle:
    continue }}
    {{ if m.tx_resultado: }}
        {{ ambiente = m.tx_ambiente.lower() if m.tx_ambiente else 'otros' }}
        {{ servidor = m.tx_servidor.upper() }}
        {{ instancia = m.tx_instancia.upper() }}
        {{ agrupado[ambiente][servidor][instancia].append(m) }}
    {{ pass }}
{{ pass }}
{{ orden_ambientes = ['produccion', 'calidad', 'desarrollo', 'dataguard','otros'] }}

<div class="header-controls">
    <select class="filter-select" name="filtro_resultado" onchange="location = this.value;">
        <option value="?filtro_resultado=todos" {{='selected' if request.vars.filtro_resultado=='todos' else ''}}>Todos</option>
        <option value="?filtro_resultado=distinto_ok" {{='selected' if request.vars.filtro_resultado=='distinto_ok' else ''}}>Solo alertas</option>
    </select>
    <button class="exit-button" onclick="window.location.href='{{=URL(r=request, c='default', f='index')}}'">Salir</button>
</div>

{{ for ambiente in orden_ambientes: }}
    {{ if ambiente in agrupado: }}
    <div class="ambiente-container">
        <div class="ambiente-title">{{=ambiente.upper()}}</div>
        <div class="instancias-grid">
            {{ for servidor, instancias in agrupado[ambiente].items(): }}
                {{ for instancia, rutinas in instancias.items(): }}
                    {{ alerta = any(r.tx_resultado in ("FALLO", "ALERTA") for r in rutinas) }}
                    <div class="instancia-card {{=ambiente}} {{='alerta' if alerta else ''}}">
                        <div class="instancia-header">
                            <div class="instancia-name">{{=instancia}}</div>
                            <div class="instancia-server">{{=servidor}} ({{=rutinas[0].tx_puerto}})</div>
                        </div>
                        <div class="parametros-grid">
                            {{ for r in rutinas: }}
                            <div class="parametro">
                                <div class="param-icon {{='icon-ok' if r.tx_resultado == 'OK' else 'icon-error'}}"></div>
                                <span class="param-name">{{=r.tx_rutina[:12]}}</span>
                            </div>
                            {{ pass }}
                        </div>
                    </div>
                {{ pass }}
            {{ pass }}
        </div>
    </div>
    {{ pass }}
{{ pass }}

{{pass}}

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        $('#loading-overlay').fadeOut(200, function() {
            $('#content-container').fadeIn(200);
        });
    }, 500);
    
    // Actualización automática cada 2 minutos
    setInterval(function() {
        location.reload();
    }, 120000);
});
</script>

</body>
</html>